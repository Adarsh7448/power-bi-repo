name: Validate Power BI Submission Issue

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  issues: write
  contents: read

env:
  SUBMISSION_START_UTC: "2026-01-23T04:30:00Z"
  SUBMISSION_END_UTC:   "2026-01-26T18:29:00Z"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate submission (close ONLY if created after deadline)
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const action = context.payload.action;

            const title = issue.title || "";
            const body = issue.body || "";
            const createdAt = new Date(issue.created_at);

            const start = new Date(process.env.SUBMISSION_START_UTC);
            const end   = new Date(process.env.SUBMISSION_END_UTC);

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;

            // Labels
            const validLabel = "submission:valid";
            const fixLabel = "submission:needs-fix";
            const reviewLabel = "awaiting-review";
            const lateLabel = "submission:late";

            // -----------------------------
            // 1) HARD RULE: Close ONLY if issue is OPENED after deadline
            // -----------------------------
            if (action === "opened" && createdAt > end) {
              await github.rest.issues.addLabels({
                owner, repo, issue_number,
                labels: [lateLabel]
              });

              await github.rest.issues.createComment({
                owner, repo, issue_number,
                body:
                  `â›” **Submission closed â€“ Deadline passed**\n\n` +
                  `This issue was created at **${issue.created_at} (UTC)**, which is **after the submission deadline**.\n\n` +
                  `Deadline (UTC): **${process.env.SUBMISSION_END_UTC}**\n\n` +
                  `If you believe this is an error, please contact the instructor.\n\n` +
                  `â€” Automated check`
              });

              await github.rest.issues.update({
                owner, repo, issue_number,
                state: "closed"
              });

              return;
            }

            // -----------------------------
            // 2) From here on: NO AUTO-CLOSE
            // -----------------------------

            // Title validation
            const titleOk =
              /^Power BI Assignment\s*(â€“|-)\s*2[0-9]f[0-9]00[0-9]{4}$/.test(title);

            // Artifact checks
            const imageCount =
              (body.match(/!\[.*?\]\(https?:\/\/.*?\)/g) || []).length;

            const screenshotsOk = imageCount >= 2;

            const hasLink = /(https?:\/\/\S+)/i.test(body);
            const mentionsPbix = /\.pbix/i.test(body) || /pbix/i.test(body);
            const pbixOk = hasLink || mentionsPbix;

            const problems = [];
            if (!titleOk)
              problems.push("**Title format** must be `Power BI Assignment â€“ 2xfx00xxxx`.");
            if (!screenshotsOk)
              problems.push("Please include **at least 2 screenshots** (Report + Model view).");
            if (!pbixOk)
              problems.push("Please attach the **.pbix** file or provide a valid link.");

            // -----------------------------
            // 3) Label + feedback (editable)
            // -----------------------------
            if (problems.length === 0) {
              await github.rest.issues.addLabels({
                owner, repo, issue_number,
                labels: [validLabel, reviewLabel]
              }).catch(() => {});

              await github.rest.issues.removeLabel({
                owner, repo, issue_number,
                name: fixLabel
              }).catch(() => {});

              await github.rest.issues.createComment({
                owner, repo, issue_number,
                body:
                  `âœ… **Submission received successfully**\n\n` +
                  `Your submission meets the required format and includes all required artifacts.\n\n` +
                  `I will review this and share feedback here.\n\n` +
                  `â€” Automated check`
              });
            } else {
              await github.rest.issues.addLabels({
                owner, repo, issue_number,
                labels: [fixLabel]
              }).catch(() => {});

              await github.rest.issues.removeLabel({
                owner, repo, issue_number,
                name: validLabel
              }).catch(() => {});

              await github.rest.issues.createComment({
                owner, repo, issue_number,
                body:
                  `âš ï¸ **Submission needs updates**\n\n` +
                  problems.map(p => `- ${p}`).join("\n") +
                  `\n\nðŸ‘‰ Please **edit this same issue** to fix the above. No need to create a new issue.\n\n` +
                  `â€” Automated check`
              });
            }
